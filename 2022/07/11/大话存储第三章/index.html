<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>大话存储第三章-磁盘原理与技术详解 | Smartog</title><meta name="keywords" content="《大话存储终极版》"><meta name="author" content="Smartog,2369398685@qq.com"><meta name="copyright" content="Smartog"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="一些磁盘结构示意图：    1 硬盘结构 盘片：每个盘片有上下两个盘面，从上到下从0开始编号，盘面号又叫磁头号； 磁道：磁盘格式化划分多个同心圆，同心圆轨迹叫做磁道，从最外圈向内从0开始编号；外圈线速度快，读写速度要比内圈快；每段圆弧叫一个扇区，从1开始编号，每个扇区的数据作为读写最小单位被同时读出或写入；离主轴最远的0磁道存放着用于操作系统启动必须的程序代码，PC启动后BIOS程序在加载任何操作">
<meta property="og:type" content="article">
<meta property="og:title" content="大话存储第三章-磁盘原理与技术详解">
<meta property="og:url" content="http://example.com/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E4%B8%89%E7%AB%A0/index.html">
<meta property="og:site_name" content="Smartog">
<meta property="og:description" content="一些磁盘结构示意图：    1 硬盘结构 盘片：每个盘片有上下两个盘面，从上到下从0开始编号，盘面号又叫磁头号； 磁道：磁盘格式化划分多个同心圆，同心圆轨迹叫做磁道，从最外圈向内从0开始编号；外圈线速度快，读写速度要比内圈快；每段圆弧叫一个扇区，从1开始编号，每个扇区的数据作为读写最小单位被同时读出或写入；离主轴最远的0磁道存放着用于操作系统启动必须的程序代码，PC启动后BIOS程序在加载任何操作">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Smartog/picturebed/master/img-3b64b597fee35c020340ae93261acc41.jpg">
<meta property="article:published_time" content="2022-07-11T07:00:43.000Z">
<meta property="article:modified_time" content="2022-07-11T07:11:56.780Z">
<meta property="article:author" content="Smartog">
<meta property="article:tag" content="《大话存储终极版》">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Smartog/picturebed/master/img-3b64b597fee35c020340ae93261acc41.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E4%B8%89%E7%AB%A0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.min.js',
      css: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '大话存储第三章-磁盘原理与技术详解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-07-11 15:11:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://img-blog.csdnimg.cn/8f7b645dd13642308f79801772084d7c.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">74</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Smartog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">大话存储第三章-磁盘原理与技术详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-11T07:00:43.000Z" title="发表于 2022-07-11 15:00:43">2022-07-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-11T07:11:56.780Z" title="更新于 2022-07-11 15:11:56">2022-07-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/book-reading/">book reading</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="大话存储第三章-磁盘原理与技术详解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><p>一些磁盘结构示意图：</p>
<p><img src="https://pic4.zhimg.com/80/v2-53866e1a060eeaa9b851b34a3e259008_720w.png?source=d16d100b" alt="img" style="zoom:67%;" /></p>
<p><img src="https://pic2.zhimg.com/80/v2-fc3043f83e4f680fa6f864a5e0f47085_720w.jpg" alt="img" style="zoom: 50%;" /></p>
<p><img src="https://pic2.zhimg.com/80/v2-8db87a9cbbd95a71d249b47430965877_720w.png?source=d16d100b" alt="img" style="zoom:67%;" /></p>
<h3 id="1-硬盘结构"><a href="#1-硬盘结构" class="headerlink" title="1 硬盘结构"></a><strong>1 硬盘结构</strong></h3><ul>
<li><strong>盘片：</strong>每个盘片有上下两个盘面，从上到下从0开始编号，盘面号又叫磁头号；</li>
<li><strong>磁道：</strong>磁盘格式化划分多个同心圆，同心圆轨迹叫做磁道，从最外圈向内从0开始编号；外圈线速度快，读写速度要比内圈快；每段圆弧叫一个扇区，从1开始编号，每个扇区的数据作为读写最小单位被同时读出或写入；离主轴最远的0磁道存放着用于操作系统启动必须的程序代码，PC启动后BIOS程序在加载任何操作系统或其他程序时，默认从0磁道读取代码运行。</li>
<li><strong>柱面：</strong>所有盘上的同一磁道，在竖直方向上构成一个圆柱，称为柱面；数据的读写按照柱面进行，因为选取磁头只需要电子切换，速度较快，而选取磁道需要机械切换，速度较慢；</li>
<li><strong>扇区：</strong>扇区头标存放描述扇区的元数据，CHS编址方式转向LBA编址方式，磁盘对外提供的地址全是线性的LBA（logical block address）地址；磁盘初始化时，将磁盘控制电路的ROM芯片中的对应关系数据载入缓冲区，磁盘控制器可以通过LBA找到对应的物理地址。扇区按照交叉因子（Interleave）进行编号。MFM（Modified Frequency Modulation）改进型调频制编码进行编号，不同磁道之间的Interleave不同。</li>
<li>计算机与外设交换数据用统一的抽象接口SCSI（小型计算机系统接口），Skip Mask IO促进效率提升。</li>
</ul>
<h3 id="2-磁盘高层技术"><a href="#2-磁盘高层技术" class="headerlink" title="2 磁盘高层技术"></a><strong>2 磁盘高层技术</strong></h3><ul>
<li><strong>磁盘中的队列技术：</strong>实现磁盘队列技术的控制代码放在<strong>磁盘控制电路芯片中</strong>，而不是主板的磁盘控制器上。控制器发命令给磁盘，磁盘自己的DSP固化电路或微处理器载入代码执行排队功能。但是在<strong>磁盘控制器（主板上的磁盘控制，不是磁盘控制电路本身的控制电路）</strong>电路中也要固化代码（或者在磁盘控制器驱动中加入处理排队的代码）处理排队，和磁盘配合使用，使得cpu得到自己想要的数据顺序。</li>
<li><strong>无序传输技术：</strong>能读多少先读多少，可以先读扇区的尾部，立即发给控制器待磁盘旋转到头部时再发送剩余部分。把麻烦留给控制器，把简单留给磁盘，因为控制器的速度要快很多。</li>
<li><strong>磁头扫描控制算法：</strong></li>
<li><strong>FCFS</strong>（先来先服务）：按照IO进入的先后顺序寻道，在随机的IO环境中严重影响IO效率；</li>
<li><strong>SSTF</strong>（Shortest Seek Time First）：磁头跳到距离当前磁头位置最近的一个IO磁道去读写，存在饿死；</li>
<li><strong>SCAN</strong>（回旋扫描模式）：来回到达终点折返，最传统，最经典，不会饿死任何IO；</li>
<li><strong>C-SCAN</strong>（单向扫描模式）：磁头总是从内圈向外圈扫描，达到外圈之后迅速折返。返回途中不接受任何IO；</li>
<li><strong>LOOK</strong>（智能监察扫描）和<strong>C-LOOK</strong>（智能监察单向扫描）：look模式只需要到达最两端的IO；</li>
</ul>
<h3 id="3-磁盘缓存表现为电路板上的一块RAM芯片，接受指令数据、预读"><a href="#3-磁盘缓存表现为电路板上的一块RAM芯片，接受指令数据、预读" class="headerlink" title="3 磁盘缓存表现为电路板上的一块RAM芯片，接受指令数据、预读"></a><strong>3 磁盘缓存表现为电路板上的一块RAM芯片，接受指令数据、预读</strong></h3><h3 id="4-磁盘性能影响因素"><a href="#4-磁盘性能影响因素" class="headerlink" title="4 磁盘性能影响因素"></a><strong>4 磁盘性能影响因素</strong></h3><p>磁盘每个时刻只允许一个磁头读写数据，不管盘片和磁头再多，也不可能提高硬盘的吞吐量和IO性能，只能提高容量。有人致力于磁头并发读写，将盘片与盘片形成RAID，但是目前没有可应用的产品。</p>
<ul>
<li>转速、寻道速度、单碟容量、接口速度；</li>
</ul>
<h3 id="5-硬盘接口技术"><a href="#5-硬盘接口技术" class="headerlink" title="5 硬盘接口技术"></a><strong>5 硬盘接口技术</strong></h3><p>硬盘向用户提供的物理、逻辑抽象出来的接口类型：</p>
<ul>
<li><strong>IDE（Integrated Drive Electronics）硬盘接口</strong>：也叫PATA（Parallel ATA advanced technology attachment）</li>
<li><strong>SATA硬盘接口（Serial ATA 串行传输ATA）</strong>：速度更快，可靠性更高，节省空间；</li>
<li><strong>SCSI硬盘接口（Small Computer System Interface）：</strong>具备与多种类型外设通信能力，广泛应用于小型机上的高速数据传输技术；应用范围广、多任务、带宽大、CPU占用率低；</li>
</ul>
<h3 id="6-磁盘控制器、驱动器控制电路、磁盘控制器驱动程序"><a href="#6-磁盘控制器、驱动器控制电路、磁盘控制器驱动程序" class="headerlink" title="6 磁盘控制器、驱动器控制电路、磁盘控制器驱动程序"></a><strong>6 磁盘控制器、驱动器控制电路、磁盘控制器驱动程序</strong></h3><ul>
<li><strong>磁盘控制器</strong>：硬盘接口除了将硬盘接入到磁盘控制器上的物理接口外，还有定义了一套指令系统的逻辑接口。指令集“定义了怎样向磁盘发送数据和从磁盘读出数据和其他行为”，比如SCSI和ATA指令，逻辑接口就是SCSI和ATA指令集部分。指令实体内容是需要运行于操作系统内核的驱动程序来生成。物理接口的连接，由磁盘控制器芯片负责。磁盘控制器的作用是参与底层总线的初始化、仲裁、指令传输、指令传输状态机、重传、ACK确认等。</li>
<li>将复杂的底层机制过滤掉，向驱动程序提供简洁的接口。驱动器只需将指令描述块CDB（Command Description Block include 读写设备号，起始地址etc）传递给控制器，控制器将执行后的信号返回给驱动程序。</li>
<li><strong>驱动器控制电路：</strong>我们要将磁盘控制器与磁盘驱动器控制电路区分开。<strong>驱动器控制电路</strong>位于磁盘驱动器上，专门负责直接驱动磁头臂做运动读写数据。主板上的<strong>磁盘控制器</strong>专门用来向磁盘驱动器发送指令。CPU通过主板上的导线发送ATA或者SCSI指令（CDB）给同样位于主板上的磁盘控制器，磁盘控制器继续通过线路将指令发送带磁盘驱动器并维护底层指令交互状态机，磁盘驱动器解析收到的指令控制磁头臂。</li>
<li>SCSI或者ATA指令CDB由OS内核的磁盘控制器驱动程序生成并发送。</li>
<li><strong>磁盘控制器驱动程序：</strong>机器刚启动，操作系统尚未启动并加载磁盘控制器驱动的时候，如何访问磁盘？BIOS中存放了系统初始化的必须的基本代码，在OS内核启动过程中，会用高性能的驱动程序来接管BIOS中驻留的驱动程序。</li>
</ul>
<h3 id="7-内部传输速率和外部传输速率"><a href="#7-内部传输速率和外部传输速率" class="headerlink" title="7 内部传输速率和外部传输速率"></a><strong>7 内部传输速率和外部传输速率</strong></h3><ul>
<li>磁盘内部传输速率指的是理想化的磁头读写磁盘时的最高速率。实际使用时感觉远远没有达到这一速率，因为磁盘换道需要时间。</li>
<li>磁头从盘片上将数据读出，存放在硬盘驱动器电路板上的缓存芯片内，再将数据从缓存内取出，通过外部接口传送给主板上的硬盘控制器。通过外部接口传送给主板上的硬盘控制器的传输速率称为外部传输速率。</li>
</ul>
<h3 id="8-并行传输和串行传输"><a href="#8-并行传输和串行传输" class="headerlink" title="8 并行传输和串行传输"></a><strong>8 并行传输和串行传输</strong></h3><ul>
<li>并行传输不适用于长距离信号传输。昂贵，信号衰减等；使用在短距离传输上；</li>
<li>IO延迟与Queue Depth：业界认为只要IO延迟低于20 ms，那么对于应用程序来说就是可以接受的；</li>
<li>存储设备应当提供的IOPS ：1000 ms / 20 ms = 每秒50次IO，但是可以做到几十万IOPS；</li>
<li>串行传输效率低但是传输速率非常高；</li>
</ul>
<h3 id="9-磁盘的IOPS和传输带宽（吞吐量）"><a href="#9-磁盘的IOPS和传输带宽（吞吐量）" class="headerlink" title="9 磁盘的IOPS和传输带宽（吞吐量）"></a><strong>9 磁盘的IOPS和传输带宽（吞吐量）</strong></h3><ul>
<li>每个层级对IO的定义不同，对于磁盘来说每次IO是指一次SCSI指令交互回合。写入1000个1 KB文件比写入一个1000 KB的文件用时多得多，因为前者可能进行更多的IO读写。</li>
<li>设备传输数据时数据流的速度，同一块硬盘在写入不同大小的数据时表现出来的带宽也是不同的。具有高带宽规格的硬盘在传输大块连续数据时具有优势，具有高IOPS的硬盘在传输小块不连续数据时具有优势。</li>
</ul>
<h3 id="10-固态存储介质和固态硬盘"><a href="#10-固态存储介质和固态硬盘" class="headerlink" title="10 固态存储介质和固态硬盘"></a><strong>10 固态存储介质和固态硬盘</strong></h3><ul>
<li>SSD（Solid State Drive）是一种利用Flash芯片或者DRAM芯片作为数据永久存储的硬盘。</li>
<li>SSD 无机械寻道时间，任何地址的访问开销都一样，随机IO性能很好，但是也有致命缺点；</li>
</ul>
<h3 id="10-1-SSD的硬件组成"><a href="#10-1-SSD的硬件组成" class="headerlink" title="10.1 SSD的硬件组成"></a><strong>10.1 SSD的硬件组成</strong></h3><p><strong>（1）所有的ROM和Flash芯片使用”浮动门场效应晶体管”的晶体管体来保存数据。</strong></p>
<p>每个晶体管叫一个cell，有Single Level Cell（SLC）每个cell保存1 bit数据，Multi Level Cell（MLC）每个cell可以保存2 bit数据。MLC容量是SLC两倍，成本差不过，但是复杂容易出错。</p>
<p><img src="https://picx.zhimg.com/80/v2-1e03f17dd342fd8db31d085b2f42e046_720w.png?source=d16d100b" alt="img" style="zoom:67%;" /></p>
<p>FG上的控制门CG连接着字线，当需要此cell表示0，则在CG上加一个足够高的正电压，导通S和D产生的电流，电子冲到FG中。<strong>向FG充电cell表示0，将FG放电cell表示1。</strong>在MLC中通过控制不同的电势值cell表示不同的状态。</p>
<p><strong>（2）实际使用中我们将cell有序排列起来成为二维矩阵：</strong></p>
<p><img src="https://pic3.zhimg.com/80/v2-b41d12ba1a339d9c7e42f2986e972c30_720w.png?source=d16d100b" alt="img" style="zoom:67%;" /></p>
<ul>
<li>我们用位线将一些cell的S极和D极串联，得到cell串，位线也是电源线。</li>
<li>我们用字线将位于cell串同一位置的cell的控制门CG连起来，实际上起到了并联cell串的作用。</li>
<li>每个cell串每次只能读写其中一个cell，多个cell串并联可以并行读写多位数据。一个page中所有位处于每个cell串相同位置上。</li>
</ul>
<p><strong>10.2 从Flash芯片读数据的过程</strong></p>
<p><img src="https://pic2.zhimg.com/80/v2-fd555354f58da248ab39508c76102363_720w.png?source=d16d100b" alt="img" style="zoom:67%;" /></p>
<p>当我们要读取某个page的内容，Flash Controller控制芯片将选中的这个page的字线不加电压，电势置为0。将其他的字线施加一个电压，电势升高使得S和D导通，但是这个值又不至于把FG里的电子吸出来。这样，位线的通断状态完全取决于未加电压的字线选中的cell是否有电子。</p>
<p>对于NAND Flash，NOT”被选中cell的通（0）断（1）状态”=“位线的1/0值”。把整个page的1或0传输到芯片外部放在SSD的RAM buffer中，完成一个page内容的读出。SSD的IO最小单位是一个page。</p>
<p><strong>10.3 向Flash芯片写数据的过程</strong></p>
<p><img src="https://pic1.zhimg.com/80/v2-8c4e40c2b5f9208967f455e36046d564_720w.png?source=d16d100b" alt="img" style="zoom: 67%;" /></p>
<p>Cell只能有带负电表示0，不带电表示1两种状态。而且感应电路只能表示出两种状态。Flash芯片在修改一个Cell前必须先Erase（即擦除掉）。这里的Erase是将一片连续的Cell即Block放电，将其中所有的Cell变成1状态，每次Erase必须是Block的倍数。Erase后Cell中全为1，遇到写1则不用操作，遇到写0则电路将对应的Cell的字线电压提高使得FG充电，充电之后Cell状态变为0。</p>
<p>要写入某个Cell，选中其所在的page，字线加高压，对应cell的位线加0电压。同一串的其他字线加一个稍低的高电压，不需要写入的Cell的位线也加相同的稍低的高电压。最终，不需写入的Cell的字线位线电压抵消，电子不动；需要写入的Cell由于电势差从位线汲取电子充电。</p>
<ul>
<li><strong>根本不能对同一个page中的cell既充电又放电，此乃Flash之痛。</strong>能否分两阶段写0和1？也不行。</li>
<li><strong>原因1：</strong> Cell绝缘体击穿次数是有限的。我们可以让所有Cell循环写入，不写到原地。预先准备好大片写满全1的Cell，每次写入都写到这些预先准备好的地方，只写0，如果是覆盖写，则把之前的page地址做一个重定向，Flash控制芯片保存一张重定向表。</li>
<li><strong>原因2：</strong>如果每次写入都要耗费2个周期，写性能会下降，IO一次就放电一次。这样设计者不得不一次擦除大片的Block，采用批发思想，然后写入只需1个周期。代价是后台需要不断放电“批发”。</li>
<li>SSD会以Page为单位进行写操作，写完一个Page再写下一个Page。</li>
</ul>
<h3 id="10-4-Flash芯片的通病"><a href="#10-4-Flash芯片的通病" class="headerlink" title="10.4 Flash芯片的通病"></a><strong>10.4 Flash芯片的通病</strong></h3><ul>
<li><strong>Erase Before Overwrite</strong></li>
<li>要向某个Block写入数据，不管原来Block中是1还是0，新写入的数据是1还是0，必须先Erase整个Block为全1，然后才能写新数据。这样大大增加了覆盖写的开销。</li>
<li>如果只想更改某个Block中的某个page，则在Erase之前，需将全部Block中数据读入SSD的RAM Buffer，Erase整个Block，将新page写入RAM相应位置，最后再将RAM中更新的Block写入Flash芯片中。更大增加了写开销，形成大规模的写惩罚（Write Amplification），要求SSD缓存很大。小块随机写IO会产生大倍数的写惩罚。</li>
<li>SSD向Flash的Free Space写数据没有写惩罚。刚被Erase后，SSD所有的Block对于文件系统或者SSD本身来说都是Free Space，随着数据不断写入，SSD将曾经被写入的Block记录下来，放在自己的Bitmap中，每一bit表示Flash中的一个Block。文件系统删除文件只是修改元数据，修改元数据对应的存储介质区域，没有为存储介质自身制造Free Space。所以对Flash来说Free Space会越来越少，最后没有Free Space每个写都有写惩罚。每个Block中的page必须按照同一个方向写入，SSD控制器记录每个Block内部大段连续空间，可以追加写入连续的page，一般来讲，控制器尽量一次写满整个Block。</li>
<li><strong>Wear Off</strong></li>
<li>随着FG充放电次数变多，二氧化硅绝缘层将损耗，失去绝缘性无法保证FG中保有足够电荷，此时Cell损坏，称为Wear Off，所在的整个page标记为损坏。</li>
<li>SSD寻址和IO的最小单位为page，损坏page的逻辑地址被重定向到其他完好的预留page，重定向表放在SSD的ROM中，每次加点被载入RAM供随时查询。</li>
<li>写惩罚增加了不必要的擦写，大大加速Wear Off，对于读来说，每个Cell可以承受更高数量级的操作。</li>
</ul>
<h3 id="10-5-NAND与NOR"><a href="#10-5-NAND与NOR" class="headerlink" title="10.5 NAND与NOR"></a><strong>10.5 NAND与NOR</strong></h3><ul>
<li>NOR Flash多了很多导线面积增大，优点是Cell独立寻址，可直接用地址线寻址，读效率比NAND高，所以可以直接当RAM用，但是擦除单位小，效率比NAND低，不利于写频繁的场景。</li>
</ul>
<h3 id="10-5-面对通病的五种方法"><a href="#10-5-面对通病的五种方法" class="headerlink" title="10.5 面对通病的五种方法"></a><strong>10.5 面对通病的五种方法</strong></h3><ul>
<li><strong>拆东墙补西墙：</strong></li>
<li>Wear Leveling：为避免同一个Cell被高频率擦写，每次针对某段逻辑LBA地址都写到SSD的Free Space中，无需再做Copy On Write操作。再次遇到针对这个LBA的写操作，SSD将待写入的数据重定向到Free Space中，将之前这个LBA占用的page标记为Garbage，可以回收利用。等到Block中一定比例的page被标记为Garbage，且存在大批满足条件的Block，SSD回批量回收这些Block，执行Copy On Write。将没被标记的page复制到RAM Buffer，汇聚，重写到新Erase的Block中。</li>
<li>又可以称为RoW，即Redirect On Write：遇到需要更新的页面Flash控制器将其缓存到RAM中，当缓存的待写入页面到达了一个Block的容量时，直接将其写入擦好的Block中。如果待写入的page没满一个Block，也会写入，不过要记录端点以供后边继续写入。</li>
<li><strong>定期清除体内垃圾，轻装上阵：</strong></li>
<li>SSD自身认识到的Free Space永远少于文件系统认识到的Free Space。所有SSD厂商均提供一个Wiper工具，在OS中运行这个工具，其扫描文件系统内不用的逻辑地址并通知给SSD，SSD可以将对应的Block做擦除并回收到Free Space空间。如果用户向SSD中写满文件又删除这些文件，务必运行Wiper让SSD回收这些垃圾。</li>
<li><strong>调节代谢持续清除体内垃圾：</strong></li>
<li>TRIM可以让文件系统删除某个文件后实时通知SSD回收对应空间。</li>
<li><strong>Delay/Combine Write：</strong></li>
<li>Delay Write：是一种存储系统常用的写优化措施。比如先后在统一地址进行两次IO——Write 1和Write 2，则可以直接Write 2。但是控制器在处理Delay Write时要小心针对同一个地址的两次写IO之间是否存在读IO，如果有读IO，先处理读再覆盖写。</li>
<li>Combine Write：对于机械硬盘的存储系统，控制器收到多个写IO的地址在逻辑上是连续的，则可以合并为针对整体连续地址的大IO，节约SCSI周期。对于SSD来说，逻辑地址本来就是被杂乱映射到可能不连续的物理地址上，所以SSD控制器可以整合任何地址的小块写IO成一个大的写IO，整合之后的大写IO被直接写入一个Free的Block中，大大提升效率。</li>
<li><strong>救命稻草，有备无患：</strong> SSD预留一部分空间用来重定向写，文件系统不知道。SSD自身对接受的写IO数据使用Write Back模式，接收到主机控制器的数据后立即返回成功，然后异步后台处理与刷盘。所以一旦掉电，必须有保护机制，一般使用一个超级电容维持掉电后的脏数据刷盘。</li>
</ul>
<p><strong>12 网中有网</strong></p>
<p><img src="https://pica.zhimg.com/80/v2-b837832f8c2ccc566dbd32b463f5cec1_720w.png?source=d16d100b" alt="img" style="zoom:50%;" /></p>
<p>Flash Aware FS： TrueFFS、ExtremeFFS。这些能够感知Flash存储方式的FS，可以将大部分SSD内部执行的逻辑拿到FS层来实现。</p>
<h3 id="13-相关术语："><a href="#13-相关术语：" class="headerlink" title="13 相关术语："></a><strong>13 相关术语：</strong></h3><p><strong>（1）FTL （Flash Translation Layer）</strong>：NAND flash管理的核心，把Flash基于页面为最小IO单元映射成传统的块设备以512 B扇区为最小IO单位，把逻辑IO地址映射成物理IO地址。FTL同时掌管映射处理和对Flash磨损均衡、垃圾回收、纠错等。FTL层是SSD中一个重要组成部分的一种“设计方案”，类似于数学公式，可以在主控里面用软件实现。</p>
<p>杂谈闪存三：FTL - 老狼的文章 - 知乎 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/26944064">https://zhuanlan.zhihu.com/p/26944064</a></p>
<p><strong>（2）SATA 与 PCIE 是传输接口：</strong></p>
<p><strong>SATA与PCIE都是总线标准</strong>，两者的区别在于SATA执行的AHCI协议标准，传输速度目前最高6Gbps；而PCIE传输速度最高可达32Gbps，兼容AHCI标准的SSD，也兼容NVMe标准的SSD。</p>
<ul>
<li><strong>SATA是一种物理接口：目前最为廉价和常见的的HDD/SSD硬盘接口，</strong>主要优缺点如下：</li>
<li>优点：稳定成熟，且性价比高；</li>
<li>缺点：带宽最高仅6Gbps，不支持NVMe新技术，而且体积相对比较大。</li>
<li><strong>PCI-E硬盘接口</strong>：相较于SATA硬盘，PCI-E 硬盘通过PCI-E总线与CPU直连，省去了内存调用硬盘的过程，传输效率与速度都成倍提升。但由于闪存颗粒和主控品质问题，PCI-E 硬盘总体成本较高。</li>
</ul>
<p><strong>（3）NVMe，AHCI和IDE是传输协议（语言）</strong> </p>
<ul>
<li>运行在诸如PCIE或SATA之类的传输接口之上。</li>
<li>现在市面上 SSD接入PC 的主要接口 是 SATA。其采用命令协议AHCI（它还支持IDE）是为寻道旋转磁盘设计的, 而不是闪存。</li>
<li>NVMe是最新的高性能和优化协议，取代了AHCI，并支持PCIE技术。</li>
</ul>
<p><strong>（4）目前PCIE Flash的专用IO协议有NVMe和SCSIe两种</strong></p>
<p><img src="https://pic1.zhimg.com/80/v2-4f443cf46ae4481fa6e41cad45f7c501_720w.png?source=d16d100b" alt="img" style="zoom:50%;" /></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Smartog</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E4%B8%89%E7%AB%A0/">http://example.com/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E4%B8%89%E7%AB%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Smartog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E3%80%8A%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%BB%88%E6%9E%81%E7%89%88%E3%80%8B/">《大话存储终极版》</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/Smartog/picturebed/master/img-3b64b597fee35c020340ae93261acc41.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/ShareJS/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/ShareJS/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://img-blog.csdnimg.cn/9732abb7d2ec4ba09cba5cf29507e04f.jpeg" target="_blank"><img class="post-qr-code-img" src="https://img-blog.csdnimg.cn/9732abb7d2ec4ba09cba5cf29507e04f.jpeg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://img-blog.csdnimg.cn/899038c3a02c4a14925da419444eb3a4.jpeg" target="_blank"><img class="post-qr-code-img" src="https://img-blog.csdnimg.cn/899038c3a02c4a14925da419444eb3a4.jpeg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E5%9B%9B%E7%AB%A0/"><img class="prev-cover" src="https://raw.githubusercontent.com/Smartog/picturebed/master/img-3b64b597fee35c020340ae93261acc41.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">大话存储第四章-详解七种RAID（主要RAID5）</div></div></a></div><div class="next-post pull-right"><a href="/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E4%BA%8C%E7%AB%A0/"><img class="next-cover" src="https://raw.githubusercontent.com/Smartog/picturebed/master/img-a6fc1290619a7baea605c9c79412d4a2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">大话存储第二章-IO</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E4%B8%80%E7%AB%A0/" title="大话存储第一章-存储发展史"><img class="cover" src="https://raw.githubusercontent.com/Smartog/picturebed/master/img-a6fc1290619a7baea605c9c79412d4a2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-11</div><div class="title">大话存储第一章-存储发展史</div></div></a></div><div><a href="/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E4%B8%83%E7%AB%A0/" title="大话存储第七章-熟读宝典—系统与系统之间的语言OSI"><img class="cover" src="https://raw.githubusercontent.com/Smartog/picturebed/master/img-a6fc1290619a7baea605c9c79412d4a2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-11</div><div class="title">大话存储第七章-熟读宝典—系统与系统之间的语言OSI</div></div></a></div><div><a href="/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E4%BA%8C%E7%AB%A0/" title="大话存储第二章-IO"><img class="cover" src="https://raw.githubusercontent.com/Smartog/picturebed/master/img-a6fc1290619a7baea605c9c79412d4a2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-11</div><div class="title">大话存储第二章-IO</div></div></a></div><div><a href="/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E4%BA%94%E7%AB%A0/" title="大话存储第五章-RAID、虚拟磁盘、卷和文件系统实战"><img class="cover" src="https://raw.githubusercontent.com/Smartog/picturebed/master/img-91c6a55525b25b0bc9ed2b3dee91024f.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-11</div><div class="title">大话存储第五章-RAID、虚拟磁盘、卷和文件系统实战</div></div></a></div><div><a href="/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E5%85%AD%E7%AB%A0/" title="大话存储第六章-磁盘阵列"><img class="cover" src="https://raw.githubusercontent.com/Smartog/picturebed/master/img-3b64b597fee35c020340ae93261acc41.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-11</div><div class="title">大话存储第六章-磁盘阵列</div></div></a></div><div><a href="/2022/07/11/%E5%A4%A7%E8%AF%9D%E5%AD%98%E5%82%A8%E7%AC%AC%E5%9B%9B%E7%AB%A0/" title="大话存储第四章-详解七种RAID（主要RAID5）"><img class="cover" src="https://raw.githubusercontent.com/Smartog/picturebed/master/img-3b64b597fee35c020340ae93261acc41.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-11</div><div class="title">大话存储第四章-详解七种RAID（主要RAID5）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%A1%AC%E7%9B%98%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">1 硬盘结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%A3%81%E7%9B%98%E9%AB%98%E5%B1%82%E6%8A%80%E6%9C%AF"><span class="toc-number">2.</span> <span class="toc-text">2 磁盘高层技术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%A3%81%E7%9B%98%E7%BC%93%E5%AD%98%E8%A1%A8%E7%8E%B0%E4%B8%BA%E7%94%B5%E8%B7%AF%E6%9D%BF%E4%B8%8A%E7%9A%84%E4%B8%80%E5%9D%97RAM%E8%8A%AF%E7%89%87%EF%BC%8C%E6%8E%A5%E5%8F%97%E6%8C%87%E4%BB%A4%E6%95%B0%E6%8D%AE%E3%80%81%E9%A2%84%E8%AF%BB"><span class="toc-number">3.</span> <span class="toc-text">3 磁盘缓存表现为电路板上的一块RAM芯片，接受指令数据、预读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%A3%81%E7%9B%98%E6%80%A7%E8%83%BD%E5%BD%B1%E5%93%8D%E5%9B%A0%E7%B4%A0"><span class="toc-number">4.</span> <span class="toc-text">4 磁盘性能影响因素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E7%A1%AC%E7%9B%98%E6%8E%A5%E5%8F%A3%E6%8A%80%E6%9C%AF"><span class="toc-number">5.</span> <span class="toc-text">5 硬盘接口技术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%A3%81%E7%9B%98%E6%8E%A7%E5%88%B6%E5%99%A8%E3%80%81%E9%A9%B1%E5%8A%A8%E5%99%A8%E6%8E%A7%E5%88%B6%E7%94%B5%E8%B7%AF%E3%80%81%E7%A3%81%E7%9B%98%E6%8E%A7%E5%88%B6%E5%99%A8%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">6.</span> <span class="toc-text">6 磁盘控制器、驱动器控制电路、磁盘控制器驱动程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%86%85%E9%83%A8%E4%BC%A0%E8%BE%93%E9%80%9F%E7%8E%87%E5%92%8C%E5%A4%96%E9%83%A8%E4%BC%A0%E8%BE%93%E9%80%9F%E7%8E%87"><span class="toc-number">7.</span> <span class="toc-text">7 内部传输速率和外部传输速率</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%B9%B6%E8%A1%8C%E4%BC%A0%E8%BE%93%E5%92%8C%E4%B8%B2%E8%A1%8C%E4%BC%A0%E8%BE%93"><span class="toc-number">8.</span> <span class="toc-text">8 并行传输和串行传输</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E7%A3%81%E7%9B%98%E7%9A%84IOPS%E5%92%8C%E4%BC%A0%E8%BE%93%E5%B8%A6%E5%AE%BD%EF%BC%88%E5%90%9E%E5%90%90%E9%87%8F%EF%BC%89"><span class="toc-number">9.</span> <span class="toc-text">9 磁盘的IOPS和传输带宽（吞吐量）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E5%9B%BA%E6%80%81%E5%AD%98%E5%82%A8%E4%BB%8B%E8%B4%A8%E5%92%8C%E5%9B%BA%E6%80%81%E7%A1%AC%E7%9B%98"><span class="toc-number">10.</span> <span class="toc-text">10 固态存储介质和固态硬盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-SSD%E7%9A%84%E7%A1%AC%E4%BB%B6%E7%BB%84%E6%88%90"><span class="toc-number">11.</span> <span class="toc-text">10.1 SSD的硬件组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-Flash%E8%8A%AF%E7%89%87%E7%9A%84%E9%80%9A%E7%97%85"><span class="toc-number">12.</span> <span class="toc-text">10.4 Flash芯片的通病</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-NAND%E4%B8%8ENOR"><span class="toc-number">13.</span> <span class="toc-text">10.5 NAND与NOR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-%E9%9D%A2%E5%AF%B9%E9%80%9A%E7%97%85%E7%9A%84%E4%BA%94%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="toc-number">14.</span> <span class="toc-text">10.5 面对通病的五种方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD%EF%BC%9A"><span class="toc-number">15.</span> <span class="toc-text">13 相关术语：</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By Smartog</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/pluginsSrc/medium-zoom/dist/medium-zoom.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = '/pluginsSrc/mathjax/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="/pluginsSrc/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="/pluginsSrc/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>